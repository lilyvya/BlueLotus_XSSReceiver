function checkNewMessages(){$.ajax({url:urlbase+"?cmd=id_list",dataType:"json",timeout:interval,success:function(e){if(messageList){var t=0,a=null;for(var i in e)messageList.indexOf(e[i])<0&&(t++,a=e[i]);t>0&&showNotification(t,a,interval)}messageList=e},complete:function(e,t){"timeout"==t?(interval*=2,setIntervalID&&(clearInterval(setIntervalID),interval<3e4&&(setIntervalID=setInterval(checkNewMessages,interval)))):"parsererror"==t&&(window.location.href="login.php")}})}function get_client_info(e){var t="未知浏览器",a="";if(e.indexOf("Firefox/")>0){var i=e.match(/Firefox\/([^;)]+)+/i);t="Firefox",a=i[1]}else if(e.indexOf("Maxthon")>0){i=e.match(/Maxthon\/([\d\.]+)/);t="傲游",a=i[1]}else if(e.indexOf("MSIE")>0){i=e.match(/MSIE\s+([^;)]+)+/i);t="IE",a=i[1]}else if(e.indexOf("OPR")>0){i=e.match(/OPR\/([\d\.]+)/);t="Opera",a=i[1]}else if(e.indexOf("Edge")>0){i=e.match(/Edge\/([\d\.]+)/);t="Edge",a=i[1]}else if(e.indexOf("Chrome")>0){i=e.match(/Chrome\/([\d\.]+)/);t="Chrome",a=i[1]}else if(e.indexOf("rv:")>0&&e.indexOf("Gecko")>0){i=e.match(/rv:([\d\.]+)/);t="IE",a=i[1]}a=a.match(/^[0-9\.]+$/)?a:"未知";var n="未知操作系统";return e.match(/win/i)&&e.indexOf("95")>0?n="Windows 95":e.match(/win 9x/i)&&e.indexOf("4.90")>0?n="Windows ME":e.match(/win/i)&&e.match(/98/i)?n="Windows 98":e.match(/win/i)&&e.match(/nt 6.0/i)?n="Windows Vista":e.match(/win/i)&&e.match(/nt 6.1/i)?n="Windows 7":e.match(/win/i)&&e.match(/nt 6.2/i)?n="Windows 8":e.match(/win/i)&&e.match(/nt 10.0/i)?n="Windows 10":e.match(/win/i)&&e.match(/nt 5.1/i)?n="Windows XP":e.match(/win/i)&&e.match(/nt 5/i)?n="Windows 2000":e.match(/win/i)&&e.match(/nt/i)?n="Windows NT":e.match(/win/i)&&e.match(/32/i)?n="Windows 32":e.match(/linux/i)?n="Linux":e.match(/unix/i)?n="Unix":e.match(/sun/i)&&e.match(/os/i)?n="SunOS":e.match(/ibm/i)&&e.match(/os/i)?n="IBM OS/2":e.match(/Mac/i)&&e.match(/PC/i)?n="Macintosh":e.match(/PowerPC/i)?n="PowerPC":e.match(/AIX/i)?n="AIX":e.match(/HPUX/i)?n="HPUX":e.match(/NetBSD/i)?n="NetBSD":e.match(/BSD/i)?n="BSD":e.match(/OSF1/i)?n="OSF1":e.match(/IRIX/i)?n="IRIX":e.match(/FreeBSD/i)?n="FreeBSD":e.match(/teleport/i)?n="teleport":e.match(/flashget/i)?n="flashget":e.match(/webzip/i)?n="webzip":e.match(/offline/i)&&(n="offline"),n+" "+t+"("+a+")"}var urlbase="./api.php",messageList=null,setIntervalID=null,interval=2e3;$(document).ready(function(){var e=this,t=$("#nav-section").height()-$("#dash-logo").outerHeight(!0);$("#deleteConfirmWindow").jqxWindow({height:100,width:270,resizable:!1,isModal:!0,modalOpacity:.3,okButton:$("#deleteConfirm_ok"),cancelButton:$("#deleteConfirm_cancel"),autoOpen:!1}),$("#deleteConfirm_ok").jqxButton({width:"65px"}),$("#deleteConfirm_cancel").jqxButton({width:"65px"}),$("#deleteConfirmWindow").on("close",function(e){if(e.args.dialogResult.OK){var t=$("#panelGrid").jqxGrid("getselectedrowindex"),a=$("#panelGrid").jqxGrid("getrowid",t);$.ajax({url:urlbase+"?cmd=del&id="+a,dataType:"json",timeout:interval,success:function(e){1==e?$("#panelGrid").jqxGrid("deleterow",a):$("#failedWindow").jqxWindow("open")},complete:function(e,t){"timeout"==t?$("#failedWindow").jqxWindow("open"):"parsererror"==t&&(window.location.href="login.php")}})}}),$("#clearConfirmWindow").jqxWindow({height:100,width:270,resizable:!1,isModal:!0,modalOpacity:.3,okButton:$("#clearConfirm_ok"),cancelButton:$("#clearConfirm_cancel"),autoOpen:!1}),$("#clearConfirm_ok").jqxButton({width:"65px"}),$("#clearConfirm_cancel").jqxButton({width:"65px"}),$("#clearConfirmWindow").on("close",function(e){e.args.dialogResult.OK&&$.ajax({url:urlbase+"?cmd=clear",dataType:"json",timeout:interval,success:function(e){1==e?$("#panelGrid").jqxGrid("clear"):$("#failedWindow").jqxWindow("open")},complete:function(e,t){"timeout"==t?$("#failedWindow").jqxWindow("open"):"parsererror"==t&&(window.location.href="login.php")}})}),$("#logoutConfirmWindow").jqxWindow({height:100,width:270,resizable:!1,isModal:!0,modalOpacity:.3,okButton:$("#logoutConfirm_ok"),cancelButton:$("#logoutConfirm_cancel"),autoOpen:!1}),$("#logoutConfirm_ok").jqxButton({width:"65px"}),$("#logoutConfirm_cancel").jqxButton({width:"65px"}),$("#logoutConfirmWindow").on("close",function(e){e.args.dialogResult.OK&&(window.location.href="logout.php")}),$("#logout").click(function(e){$("#logoutConfirmWindow").jqxWindow("open"),e.preventDefault()}),$("#failedWindow").jqxWindow({height:100,width:270,resizable:!1,isModal:!0,modalOpacity:.3,okButton:$("#failed_ok"),autoOpen:!1}),$("#failed_ok").jqxButton({width:"65px"}),$("#searchWindow").jqxWindow({resizable:!1,autoOpen:!1,isModal:!0,modalOpacity:.3,width:210,height:180}),$("#findButton").jqxButton({width:70}),$("#clearButton").jqxButton({width:70}),$("#dropdownlist").jqxDropDownList({autoDropDownHeight:!0,selectedIndex:0,width:200,height:23,source:["时间","IP","来源","客户端","请求","携带数据","保持连接"]}),$("#findButton").click(function(){$("#panelGrid").jqxGrid("clearfilters");var e=$("#dropdownlist").jqxDropDownList("selectedIndex"),t="";switch(e){case 0:t="request_date_and_time_string";break;case 1:t="user_IP";break;case 2:t="location";break;case 3:t="client";break;case 4:t="request_method";break;case 5:t="data_type";break;case 6:t="keepsession"}var a=$("#search_input_field").val(),i=new $.jqx.filter,n=1,d=a,o="contains",l=i.createfilter("stringfilter",d,o);i.addfilter(n,l),$("#panelGrid").jqxGrid("addfilter",t,i),$("#panelGrid").jqxGrid("applyfilters")}),$("#clearButton").click(function(){$("#panelGrid").jqxGrid("clearfilters")}),$(window).resize(function(){var e=$("#nav-section").height()-$("#dash-logo").outerHeight(!0);$("#panelGrid").jqxGrid({height:e>0?e:0})});var a={datatype:"json",datafields:[{name:"user_IP"},{name:"location"},{name:"data_type"},{name:"keepsession"},{name:"user_port"},{name:"protocol"},{name:"request_method"},{name:"request_URI"},{name:"request_time"},{name:"headers_data"},{name:"get_data"},{name:"post_data"},{name:"cookie_data"},{name:"decoded_get_data"},{name:"decoded_post_data"},{name:"decoded_cookie_data"},{name:"request_date_string"},{name:"request_time_string"},{name:"request_date_and_time_string"},{name:"client"}],id:"request_time",url:urlbase+"?cmd=list",root:"data"},i=new $.jqx.dataAdapter(a,{downloadComplete:function(e,t,a){if("success"==t){for(var i=e.length;i--;){var n=new Date(1e3*e[i].request_time);e[i].request_date_string=n.getFullYear()+"年"+(n.getMonth()+1)+"月"+n.getDate()+"日",e[i].request_time_string=n.getHours()+":"+n.getMinutes()+":"+n.getSeconds(),e[i].request_date_and_time_string=e[i].request_date_string+" "+e[i].request_time_string,e[i].keepsession=!0===e[i].keepsession?"是":"否",e[i].client=e[i].headers_data["User-Agent"]?get_client_info(e[i].headers_data["User-Agent"]):"未知";var d={},o=Object.keys(e[i].get_data),l=Object.keys(e[i].post_data),r=Object.keys(e[i].cookie_data);o.length>0&&(d.GET=o),l.length>0&&(d.POST=l),r.length>0&&(d.COOKIE=r),e[i].data_type=JSON.stringify(d)}return e}}}),n=function(e,t,a,i){var n=null,d=null,o=null,l=null,r=null,s=null;if(n=$($(t).children()[0]),null!==n){d=n.find(".information"),o=n.find(".get_grid"),l=n.find(".post_grid"),r=n.find(".cookie_grid"),s=n.find(".headers_grid");var c=[];for(var p in i.get_data){var m=[];m.push(p),m.push(i.get_data[p]);var h="";i.decoded_get_data&&(h=i.decoded_get_data[p]),m.push(h),c.push(m)}var u={localdata:c,datafields:[{name:"key",type:"string",map:"0"},{name:"value",type:"string",map:"1"},{name:"decoded_value",type:"string",map:"2"}],datatype:"array"},g=new $.jqx.dataAdapter(u);o.jqxGrid({autorowheight:!0,columnsautoresize:!0,pageable:!0,pagermode:"simple",scrollmode:"deferred",localization:getLocalization("zh"),enablebrowserselection:!0,columnsresize:!0,height:176,width:"100%",source:g,ready:function(){u.localdata.length&&u.localdata.length>0&&o.jqxGrid("autoresizecolumn","key")},columns:i.decoded_get_data?[{text:"键",datafield:"key"},{text:"值",datafield:"value"},{text:"解码",datafield:"decoded_value"}]:[{text:"键",datafield:"key"},{text:"值",datafield:"value"}]});var f=[];for(p in i.post_data){var x=[];x.push(p),x.push(i.post_data[p]);h="";i.decoded_post_data&&(h=i.decoded_post_data[p]),x.push(h),f.push(x)}var w={localdata:f,datafields:[{name:"key",type:"string",map:"0"},{name:"value",type:"string",map:"1"},{name:"decoded_value",type:"string",map:"2"}],datatype:"array"},v=new $.jqx.dataAdapter(w);l.jqxGrid({ready:function(){w.localdata.length&&w.localdata.length>0&&l.jqxGrid("autoresizecolumn","key")},autorowheight:!0,pageable:!0,columnsautoresize:!0,pagermode:"simple",scrollmode:"deferred",localization:getLocalization("zh"),enablebrowserselection:!0,columnsresize:!0,height:176,width:"100%",source:v,columns:i.decoded_post_data?[{text:"键",datafield:"key"},{text:"值",datafield:"value"},{text:"解码",datafield:"decoded_value"}]:[{text:"键",datafield:"key"},{text:"值",datafield:"value"}]});var _=[];for(p in i.cookie_data){var y=[];y.push(p),y.push(i.cookie_data[p]);h="";i.decoded_cookie_data&&(h=i.decoded_cookie_data[p]),y.push(h),_.push(y)}var q={localdata:_,datafields:[{name:"key",type:"string",map:"0"},{name:"value",type:"string",map:"1"},{name:"decoded_value",type:"string",map:"2"}],datatype:"array"},j=new $.jqx.dataAdapter(q);r.jqxGrid({ready:function(){q.localdata.length&&q.localdata.length>0&&r.jqxGrid("autoresizecolumn","key")},columnsautoresize:!0,autorowheight:!0,pageable:!0,pagermode:"simple",scrollmode:"deferred",localization:getLocalization("zh"),enablebrowserselection:!0,columnsresize:!0,height:176,width:"100%",source:j,columns:i.decoded_cookie_data?[{text:"键",datafield:"key"},{text:"值",datafield:"value"},{text:"解码",datafield:"decoded_value"}]:[{text:"键",datafield:"key"},{text:"值",datafield:"value"}]});var b=[];for(p in i.headers_data){var k=[];k.push(p),k.push(i.headers_data[p]),b.push(k)}var z={localdata:b,datafields:[{name:"key",type:"string",map:"0"},{name:"value",type:"string",map:"1"}],datatype:"array"},G=new $.jqx.dataAdapter(z);s.jqxGrid({ready:function(){z.localdata.length&&z.localdata.length>0&&s.jqxGrid("autoresizecolumn","key")},columnsautoresize:!0,autorowheight:!0,pageable:!0,pagermode:"simple",scrollmode:"deferred",localization:getLocalization("zh"),enablebrowserselection:!0,columnsresize:!0,width:"100%",height:176,source:G,columns:[{text:"键",datafield:"key"},{text:"值",datafield:"value"}]});var W=$('<div style="margin: 25px;"></div>');W.appendTo($(d));var O=$('<div style="float: left; width: 45%;"></div>'),I=$('<div style="float: left; width: 40%;"></div>');W.append(O),W.append(I);var B="<div style='margin: 10px;'><b>日期：</b> "+i.request_date_string+"</div>",C="<div style='margin: 10px;'><b>IP：</b> "+i.user_IP+"</div>",D="<div style='margin: 10px;'><b>协议：</b> "+i.request_method+"</div>",M="<div style='margin: 10px;'><b>位置：</b> "+i.location+"</div>";if($(O).append(B),$(O).append(C),$(O).append(D),$(O).append(M),null!=i.post_data&&null!=i.post_data.screenshot){var P="<div style='margin: 10px;'><b>截图：</b><br><a target='_blank' href='"+i.post_data.screenshot+"'><img height='280px' src='"+i.post_data.screenshot+"'/></a></div>";$(O).append(P)}var S="<div style='margin: 10px;'><b>时间：</b> "+i.request_time_string+"</div>",L="<div style='margin: 10px;'><b>端口：</b> "+i.user_port+"</div>",T="<div style='margin: 10px;'><b>访问地址：</b> "+i.request_URI+"</div>",E="<div style='margin: 10px;'><b>客户端：</b> "+i.client+"</div>";$(I).append(S),$(I).append(L),$(I).append(T),$(I).append(E),$(n).jqxTabs({width:"95%",height:"100%"})}};$("#panelGrid").jqxGrid({pageable:!0,ready:function(){checkNewMessages(),setIntervalID=setInterval(checkNewMessages,interval)},pagerrenderer:function(){var t=$("<div style='overflow: hidden; position: relative; '></div>"),a=$("<div style='float: left; margin-left: 5px;'><img style='position: relative; margin-top: 2px;' src='static/images/delete.png'/><span style='margin-left: 4px; position: relative; top: 3px;'>删除</span></div>"),i=$("<div style='float: left; margin-left: 5px;'><img style='position: relative; margin-top: 2px;' src='static/images/clear.png'/><span style='margin-left: 4px; position: relative; top: 3px;'>清空</span></div>"),n=$("<div style='float: left; margin-left: 5px;'><img style='position: relative; margin-top: 2px;' src='static/images/search.png'/><span style='margin-left: 4px; position: relative; top: 3px;'>查询</span></div>");t.append(a),t.append(i),t.append(n),a.jqxButton({width:65,height:20}),i.jqxButton({width:65,height:20}),n.jqxButton({width:65,height:20}),a.click(function(e){var t=$("#panelGrid").jqxGrid("getselectedrowindex");t>=0&&$("#deleteConfirmWindow").jqxWindow("open")}),i.click(function(e){$("#clearConfirmWindow").jqxWindow("open")}),n.click(function(e){$("#searchWindow").jqxWindow("open")});var d=$("<div style='overflow: hidden;float: right;position: relative;margin: 5.5px; '></div>"),o=$("#panelGrid").jqxGrid("getdatainformation"),l=o.paginginformation,r=$("<div style='padding: 0px; float: left;'><div style='margin-left: 9px; width: 16px; height: 16px;'></div></div>");r.find("div").addClass("jqx-icon-arrow-left"),r.width(36),r.jqxButton({theme:"energyblue"});var s=$("<div style='padding: 0px; margin: 0px 3px; float: left;'><div style='margin-left: 9px; width: 16px; height: 16px;'></div></div>");s.find("div").addClass("jqx-icon-arrow-right"),s.width(36),s.jqxButton({theme:"energyblue"});var c=$("<div style='font-size: 14px; margin: 1px 1px; font-weight: bold; float: left;'></div>");return c.text("1-"+l.pagesize+" of "+o.rowscount),r.appendTo(d),s.appendTo(d),c.appendTo(d),d.appendTo(t),e.label=c,s.click(function(){$("#panelGrid").jqxGrid("gotonextpage")}),r.click(function(){$("#panelGrid").jqxGrid("gotoprevpage")}),t},scrollmode:"logical",sortable:!0,pagesize:25,localization:getLocalization("zh"),width:"100%",height:t-2>0?t-2:0,source:i,enablebrowserselection:!0,columnsresize:!0,rowdetails:!0,rowdetailstemplate:{rowdetails:$("#xss-detail-template").html(),rowdetailsheight:222},initrowdetails:n,columns:[{text:"时间",datafield:"request_date_and_time_string",width:165},{text:"IP",datafield:"user_IP"},{text:"来源",datafield:"location"},{text:"客户端",datafield:"client"},{text:"请求",datafield:"request_method",width:55},{text:"携带数据",datafield:"data_type"},{text:"保持连接",datafield:"keepsession",width:60,cellsalign:"center"}]}),$("#panelGrid").on("pagechanged",function(){var t=$("#panelGrid").jqxGrid("getdatainformation"),a=t.paginginformation;e.label.text(1+a.pagenum*a.pagesize+"-"+Math.min(t.rowscount,(a.pagenum+1)*a.pagesize)+" of "+t.rowscount)})});